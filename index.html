<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoFlite Social Media</title>
    <!-- Tailwind CSS CDN for modern styling and responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* General body and font styling for a light theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light background */
            color: #1c2a39; /* Dark text */
            height: 100vh;
        }
        /* Custom "liquid glass" effect class */
        .liquid-glass {
            background-color: rgba(255, 255, 255, 0.6); /* Semi-transparent white */
            backdrop-filter: blur(20px); /* The key to the liquid glass effect */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        /* Hover effect for liquid glass elements */
        .liquid-glass:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        /* Smooth animation for page transitions */
        .fade-in {
            animation: fadeIn 0.8s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar styling for a clean look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(200, 200, 200, 0.5);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
            border: 2px solid rgba(200, 200, 200, 0);
        }
        /* Style for a custom, no-alert message box */
        #messageBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            text-align: center;
        }
        #messageBox.show {
            opacity: 1;
            pointer-events: auto;
        }
        /* Hide a section to start with */
        .section.hidden {
            display: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-8 bg-gradient-to-br from-indigo-100 via-white to-sky-100">

<!-- Custom Message Box for non-alert notifications -->
<div id="messageBox" class="bg-blue-600 text-white shadow-lg"></div>

<!-- Login/Signup Page -->
<div id="loginPage" class="liquid-glass w-full max-w-md p-8 sm:p-12 text-center fade-in overflow-y-auto max-h-[95vh] border-2 border-white">
    <h1 class="text-5xl font-extrabold text-gray-800 mb-2">RoFlite ‚úàÔ∏è</h1>
    <p class="text-sm text-gray-600 mb-8">Log in or create an account to get started!</p>
    <div class="mb-4">
        <input type="email" id="emailInput" placeholder="Email" class="w-full p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300">
    </div>
    <div class="mb-6">
        <input type="password" id="passwordInput" placeholder="Password" class="w-full p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300">
    </div>
    <button id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg">
        Login
    </button>
    <button id="signupBtn" class="w-full mt-4 bg-gray-600 text-white font-bold py-3 rounded-xl hover:bg-gray-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg">
        Sign Up
    </button>
    
    <div class="my-8">
        <div class="relative flex py-5 items-center">
            <div class="flex-grow border-t border-gray-300"></div>
            <span class="flex-shrink mx-4 text-gray-500">Or sign in with</span>
            <div class="flex-grow border-t border-gray-300"></div>
        </div>
        <div class="flex justify-center">
            <button id="googleBtn" class="flex items-center justify-center p-3 border rounded-xl hover:bg-gray-200 transition-colors duration-300 shadow-sm">
                <!-- Google Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-google-icon mr-2"><path d="M22 12h-4c0-2.03-1.65-3.67-4.14-3.96C12.39 7.7 11 8.24 11 9.5a2.5 2.5 0 0 1-5 0c0-1.26-1.39-1.8-2.86-1.54C2.65 8.33 1 10.02 1 12c0 1.98 1.65 3.67 4.14 3.96 1.47.26 2.86-.28 2.86-1.54a2.5 2.5 0 0 1 5 0c0 1.26 1.39 1.8 2.86 1.54C18.35 15.67 20 13.98 20 12h2"/><path d="M12 22a10 10 0 0 1-4.88-1.07c-3.15-.9-5.12-3.8-5.12-7.43a10 10 0 0 1 10-10 10 10 0 0 1 10 10z"/></svg>
                Google
            </button>
        </div>
    </div>
</div>

<!-- Profile Setup Modal -->
<div id="profileSetupModal" class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="liquid-glass w-full max-w-md p-8 relative fade-in text-center border-2 border-white">
        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Complete Your Profile</h3>
        <p class="text-gray-600 mb-4">You're almost there! Just a few more details to get started.</p>
        <div class="mb-4">
            <input type="text" id="airlineName" placeholder="Airline Name (e.g., Ro-Aviation)" class="w-full p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300">
        </div>
        <div class="mb-6">
            <input type="text" id="username" placeholder="Username" class="w-full p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300">
            <p id="usernameStatus" class="text-left text-xs mt-1 h-4"></p>
        </div>
        <button id="saveProfileBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg">
            Save Profile
        </button>
    </div>
</div>

<!-- Main Application Page -->
<div id="mainApp" class="hidden w-full max-w-4xl h-[90vh] md:h-[80vh] flex flex-col liquid-glass p-6 sm:p-8 fade-in border-2 border-white">
    <!-- Header with Search Bar and User ID -->
    <header class="flex flex-col sm:flex-row items-center justify-between pb-4 border-b border-gray-300 mb-4">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2 sm:mb-0">RoFlite ‚úàÔ∏è</h1>
        <div class="flex-1 max-w-xs mx-0 sm:mx-4 w-full sm:w-auto">
            <div class="relative">
                <input type="text" id="searchBar" placeholder="Search posts..." class="w-full p-3 pl-12 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-400 transition-all duration-300">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">üîç</span>
            </div>
        </div>
        <div class="flex items-center space-x-4 mt-2 sm:mt-0">
            <div class="text-xs text-right text-gray-500 break-words max-w-[200px]">
                Your ID:<br><span id="currentUserId" class="font-mono text-gray-700 text-[10px] sm:text-xs"></span>
            </div>
            <button id="logoutBtn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-red-600 transition-all duration-300">
                Log Out
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto pr-2 pb-2">
        <!-- Feed Section -->
        <div id="feedSection" class="section active">
            <h2 class="text-3xl font-bold mb-4 text-gray-800">Feed</h2>
            <div id="postsContainer" class="space-y-6">
                <!-- Posts will be dynamically inserted here -->
            </div>
        </div>

        <!-- Search Results Section -->
        <div id="searchResultsSection" class="section hidden">
            <h2 class="text-3xl font-bold mb-4 text-gray-800">Search Results</h2>
            <div id="searchResultsContainer" class="space-y-6">
                <!-- Search results will be dynamically inserted here -->
            </div>
        </div>

        <!-- Messages Section -->
        <div id="messagesSection" class="section hidden">
            <h2 class="text-3xl font-bold mb-4 text-gray-800">Messages</h2>
            <div id="messagesList" class="space-y-4">
                <!-- Messages will be dynamically inserted here -->
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="section hidden">
            <div class="flex flex-col items-center sm:flex-row sm:items-start space-y-4 sm:space-y-0 sm:space-x-8 mb-8 bg-white p-6 rounded-3xl shadow-lg">
                <img id="profileImage" src="https://placehold.co/120x120/A0AEC0/FFFFFF?text=P" class="w-32 h-32 rounded-full border-4 border-white shadow-lg">
                <div class="text-center sm:text-left">
                    <h2 class="text-3xl font-bold text-gray-800">@<span id="profileUsername" class="font-extrabold text-blue-600"></span></h2>
                    <p class="text-lg text-gray-600 mt-1">Airline: <span id="profileAirline" class="font-semibold text-gray-700"></span></p>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="section hidden">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Settings</h2>
            <div class="bg-white p-8 rounded-3xl shadow-lg space-y-6">
                <div>
                    <label for="settingsUsernameInput" class="block text-sm font-medium text-gray-700">Change Username</label>
                    <input type="text" id="settingsUsernameInput" placeholder="New Username" class="mt-1 w-full p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300">
                    <p id="settingsUsernameStatus" class="text-xs mt-1 h-4"></p>
                </div>
                <div>
                    <label for="settingsAirlineInput" class="block text-sm font-medium text-gray-700">Change Airline</label>
                    <input type="text" id="settingsAirlineInput" placeholder="New Airline" class="mt-1 w-full p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300">
                </div>
                <div class="flex items-center space-x-6">
                    <img id="currentProfilePic" src="https://placehold.co/100x100/A0AEC0/FFFFFF?text=P" class="w-24 h-24 rounded-full border-4 border-gray-300 shadow-md">
                    <label class="block">
                        <span class="sr-only">Choose profile photo</span>
                        <input type="file" id="profilePictureInput" accept="image/*" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100
                        "/>
                    </label>
                </div>
                <button id="saveSettingsBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg">
                    Save Changes
                </button>
            </div>
        </div>
        
        <!-- Admin Panel Section (Hidden by default) -->
        <div id="adminPanelSection" class="section hidden">
            <h2 class="text-3xl font-bold mb-4 text-red-600">Admin Panel üö®</h2>
            <p class="text-gray-600 mb-6">Manage users and content with caution. This panel is visible only to `adminaccount`.</p>

            <!-- User Management -->
            <div class="bg-white p-6 rounded-3xl shadow-lg mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">User Management</h3>
                <div class="mb-4">
                    <label for="adminUsernameSearchInput" class="block text-sm font-medium text-gray-700">Find User by Username</label>
                    <input type="text" id="adminUsernameSearchInput" placeholder="Enter username to find ID" class="w-full p-3 rounded-xl bg-gray-200 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="foundUserIdDisplay" class="mt-2 text-sm text-gray-600"></div>
                </div>
                <div class="mb-4">
                    <label for="adminUserIdInput" class="block text-sm font-medium text-gray-700">User ID</label>
                    <input type="text" id="adminUserIdInput" placeholder="Enter User ID to manage" class="w-full p-3 rounded-xl bg-gray-200 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                <div class="mb-4">
                    <label for="adminBanNoteInput" class="block text-sm font-medium text-gray-700">Ban/Suspension Note</label>
                    <textarea id="adminBanNoteInput" placeholder="Reason for action (required for Ban/Suspend)" class="w-full p-3 rounded-xl bg-gray-200 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 resize-none"></textarea>
                </div>
                <div class="mb-4">
                    <label for="suspendDurationInput" class="block text-sm font-medium text-gray-700">Suspension Duration (in days)</label>
                    <input type="number" id="suspendDurationInput" value="7" min="1" class="w-full p-3 rounded-xl bg-gray-200 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div class="flex space-x-4">
                    <button id="banUserBtn" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 transition duration-300">
                        Ban User
                    </button>
                    <button id="suspendUserBtn" class="flex-1 bg-yellow-600 text-white font-bold py-3 rounded-xl hover:bg-yellow-700 transition duration-300">
                        Suspend User
                    </button>
                </div>
            </div>

            <!-- Post Moderation -->
            <div class="bg-white p-6 rounded-3xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Post Moderation</h3>
                <div class="mb-4">
                    <label for="adminPostIdInput" class="block text-sm font-medium text-gray-700">Post ID</label>
                    <input type="text" id="adminPostIdInput" placeholder="Enter Post ID to take down" class="w-full p-3 rounded-xl bg-gray-200 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                <button id="takeDownPostBtn" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 transition duration-300">
                    Take Down Post
                </button>
            </div>
            
            <!-- Banned and Suspended Users Lists -->
            <div class="bg-white p-6 rounded-3xl shadow-lg mt-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Banned & Suspended Users</h3>
                <div id="bannedSuspendedList" class="space-y-4">
                    <!-- List will be populated dynamically -->
                    <p class="text-center text-gray-500">No users currently banned or suspended.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Floating Action Buttons -->
    <div class="flex justify-center space-x-4 mt-6">
        <button id="newPostBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-110">
            ‚ûï Post
        </button>
        <button id="newMessageBtn" class="bg-emerald-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-emerald-700 transition-all duration-300 transform hover:scale-110">
            üí¨ Message
        </button>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="mt-4 pt-4 border-t border-gray-300">
        <ul class="flex justify-around items-center">
            <li><button id="feedTab" class="nav-btn active text-blue-600 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">üìÑ<span class="block text-xs">Feed</span></button></li>
            <li><button id="messagesTab" class="nav-btn text-gray-400 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">‚úâÔ∏è<span class="block text-xs">Messages</span></button></li>
            <li><button id="profileTab" class="nav-btn text-gray-400 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">üë§<span class="block text-xs">Profile</span></button></li>
            <li><button id="settingsTab" class="nav-btn text-gray-400 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">‚öôÔ∏è<span class="block text-xs">Settings</span></button></li>
            <li><button id="adminTab" class="nav-btn hidden text-gray-400 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">üëÆ<span class="block text-xs">Admin</span></button></li>
        </ul>
    </nav>
</div>

<!-- New Post Modal -->
<div id="newPostModal" class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="liquid-glass w-full max-w-md p-8 relative fade-in border-2 border-white">
        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Create New Post</h3>
        <textarea id="postText" class="w-full h-32 p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300 resize-none mb-4" placeholder="What's on your mind?"></textarea>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Add an image</label>
            <input type="file" id="postImageInput" accept="image/*" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100
            "/>
            <div id="postImagePreviewContainer" class="mt-4 hidden">
                <img id="postImagePreview" class="w-full h-auto rounded-xl border-2 border-gray-300 shadow-sm">
            </div>
        </div>
        <div class="flex justify-between items-center mb-4">
            <div>
                <label for="postTextColor" class="text-gray-700">Text Color:</label>
                <input type="color" id="postTextColor" value="#1c2a39" class="h-8 w-8 rounded-full border border-gray-300 cursor-pointer">
            </div>
            <div>
                <label for="postBackgroundColor" class="text-gray-700">Background Color:</label>
                <input type="color" id="postBackgroundColor" value="#ffffff" class="h-8 w-8 rounded-full border border-gray-300 cursor-pointer">
            </div>
        </div>
        <div class="flex justify-end space-x-4">
            <button id="cancelPostBtn" class="bg-gray-400 text-gray-800 py-2 px-6 rounded-xl hover:bg-gray-500 transition-all duration-300">Cancel</button>
            <button id="submitPostBtn" class="bg-blue-600 text-white py-2 px-6 rounded-xl hover:bg-blue-700 transition-all duration-300">Post</button>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div id="newMessageModal" class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="liquid-glass w-full max-w-md p-8 relative fade-in border-2 border-white">
        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Send Private Message</h3>
        <input type="text" id="messageRecipient" placeholder="Recipient's User ID (e.g., a8c-123-abc)" class="w-full p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-emerald-500 transition duration-300 mb-4">
        <textarea id="messageText" class="w-full h-32 p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-emerald-500 transition duration-300 resize-none mb-4" placeholder="Your message..."></textarea>
        <div class="flex justify-end space-x-4">
            <button id="cancelMessageBtn" class="bg-gray-400 text-gray-800 py-2 px-6 rounded-xl hover:bg-gray-500 transition-all duration-300">Cancel</button>
            <button id="sendMessageBtn" class="bg-emerald-600 text-white py-2 px-6 rounded-xl hover:bg-emerald-700 transition-all duration-300">Send</button>
        </div>
    </div>
</div>

<!-- Post Detail Modal -->
<div id="postDetailModal" class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="liquid-glass w-full max-w-2xl h-[90vh] flex flex-col p-8 relative fade-in border-2 border-white">
        <button id="closePostDetailBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
        </button>
        <!-- Post content will be inserted here -->
        <div id="postDetailContent" class="flex-1 overflow-y-auto pr-2 pb-2 mb-4"></div>
        <!-- Reply form -->
        <div class="mt-auto pt-4 border-t border-gray-300">
            <h4 class="text-xl font-semibold mb-4 text-gray-800">Leave a Reply</h4>
            <textarea id="replyText" class="w-full h-24 p-3 rounded-xl bg-gray-200 border-2 border-transparent text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300 resize-none mb-4" placeholder="Your reply..."></textarea>
            <button id="submitReplyBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg">
                Reply
            </button>
        </div>
    </div>
</div>

<!-- JavaScript for functionality -->
<script type="module">
    // Firebase CDN imports. These are essential for connecting to the database.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, getDocs, onSnapshot, arrayUnion, arrayRemove, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your web app's Firebase configuration, as provided by you.
    const firebaseConfig = {
        apiKey: "AIzaSyDxEVWH3ukcs2C0tTa08faIGOarGsReZxo",
        authDomain: "project-7604626948994220056.firebaseapp.com",
        projectId: "project-7604626948994220056",
        storageBucket: "project-7604626948994220056.firebasestorage.app",
        messagingSenderId: "288162968865",
        appId: "1:288162968865:web:8e35c777371c1e4fe4ba60",
        measurementId: "G-N3KC2BJPR8"
    };
    
    // Global variables for Firestore and Auth.
    let db, auth, userId;
    let currentUserData = null;
    const appId = "default-app-id"; // Retaining this for Firestore pathing

    // --- DOM Elements ---
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const messageBox = document.getElementById('messageBox');
    const currentUserIdSpan = document.getElementById('currentUserId');
    const searchBar = document.getElementById('searchBar');
    const logoutBtn = document.getElementById('logoutBtn');

    const googleBtn = document.getElementById('googleBtn');

    const navButtons = document.querySelectorAll('.nav-btn');
    const sections = document.querySelectorAll('.section');
    const feedContainer = document.getElementById('postsContainer');
    const searchResultsContainer = document.getElementById('searchResultsContainer');
    const messagesList = document.getElementById('messagesList');
    const profileUsernameSpan = document.getElementById('profileUsername');
    const profileAirlineSpan = document.getElementById('profileAirline');
    const profileImage = document.getElementById('profileImage');
    
    const settingsUsernameInput = document.getElementById('settingsUsernameInput');
    const settingsAirlineInput = document.getElementById('settingsAirlineInput');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const profilePictureInput = document.getElementById('profilePictureInput');
    const currentProfilePic = document.getElementById('currentProfilePic');
    const settingsUsernameStatus = document.getElementById('settingsUsernameStatus');

    const newPostBtn = document.getElementById('newPostBtn');
    const newMessageBtn = document.getElementById('newMessageBtn');
    const newPostModal = document.getElementById('newPostModal');
    const newMessageModal = document.getElementById('newMessageModal');
    const postDetailModal = document.getElementById('postDetailModal');
    const postDetailContent = document.getElementById('postDetailContent');
    const closePostDetailBtn = document.getElementById('closePostDetailBtn');
    const replyText = document.getElementById('replyText');
    const submitReplyBtn = document.getElementById('submitReplyBtn');

    const cancelPostBtn = document.getElementById('cancelPostBtn');
    const submitPostBtn = document.getElementById('submitPostBtn');
    const cancelMessageBtn = document.getElementById('cancelMessageBtn');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const postTextarea = document.getElementById('postText');
    const messageRecipientInput = document.getElementById('messageRecipient');
    const messageTextarea = document.getElementById('messageText');
    const postTextColor = document.getElementById('postTextColor');
    const postBackgroundColor = document.getElementById('postBackgroundColor');
    
    const postImageInput = document.getElementById('postImageInput');
    const postImagePreview = document.getElementById('postImagePreview');
    const postImagePreviewContainer = document.getElementById('postImagePreviewContainer');

    const profileSetupModal = document.getElementById('profileSetupModal');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const airlineNameInput = document.getElementById('airlineName');
    const usernameInput = document.getElementById('username');
    const usernameStatus = document.getElementById('usernameStatus');

    // Admin Panel Elements
    const adminTab = document.getElementById('adminTab');
    const adminPanelSection = document.getElementById('adminPanelSection');
    const adminUsernameSearchInput = document.getElementById('adminUsernameSearchInput');
    const foundUserIdDisplay = document.getElementById('foundUserIdDisplay');
    const adminUserIdInput = document.getElementById('adminUserIdInput');
    const adminBanNoteInput = document.getElementById('adminBanNoteInput');
    const suspendDurationInput = document.getElementById('suspendDurationInput');
    const banUserBtn = document.getElementById('banUserBtn');
    const suspendUserBtn = document.getElementById('suspendUserBtn');
    const adminPostIdInput = document.getElementById('adminPostIdInput');
    const takeDownPostBtn = document.getElementById('takeDownPostBtn');
    const bannedSuspendedList = document.getElementById('bannedSuspendedList');

    // Store a map of user data for efficient lookups
    let usersDataMap = new Map();
    let usersByUsernameMap = new Map();

    // Show a temporary message to the user
    function showMessage(text, isError = false) {
        messageBox.textContent = text;
        messageBox.className = 'show ' + (isError ? 'bg-red-600' : 'bg-blue-600');
        setTimeout(() => {
            messageBox.className = '';
        }, 3000);
    }

    // Initialize Firebase and handle authentication
    async function initializeAndAuthenticate() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // This listener will trigger whenever the user signs in or out.
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    currentUserIdSpan.textContent = userId;
                    await fetchAllUsersData(); // Fetch all user data first
                    await fetchUserData(); // Then fetch current user data and check admin status
                    // Setup listeners only once we are sure the user is authenticated
                    setupRealtimeListeners();
                } else {
                    // Check if the user is banned before showing login page
                    const email = emailInput.value;
                    const q = query(collection(db, `artifacts/${appId}/public/data/banned_users`), where("email", "==", email));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const banData = querySnapshot.docs[0].data();
                        showMessage(`You have been permanently banned. Reason: ${banData.note}`, true);
                        loginPage.classList.remove('hidden');
                        mainApp.classList.add('hidden');
                        return;
                    }
                    loginPage.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                }
            });
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showMessage("Failed to initialize. Please check your Firebase config.", true);
        }
    }

    // --- Main Functions ---
    // Fetch all user data to cache it for quick lookups
    async function fetchAllUsersData() {
        try {
            const usersRef = collection(db, `artifacts/${appId}/users`);
            const usersSnapshot = await getDocs(usersRef);
            usersDataMap.clear();
            usersByUsernameMap.clear();
            usersSnapshot.forEach(userDoc => {
                const userData = userDoc.data().profile.data;
                usersDataMap.set(userDoc.id, userData);
                usersByUsernameMap.set(userData.username, userDoc.id);
            });
        } catch (e) {
            console.error("Error fetching all user data:", e);
        }
    }

    // Fetch and display current user data
    async function fetchUserData() {
        if (!userId) return;
        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists()) {
            currentUserData = userDocSnap.data();
            profileUsernameSpan.textContent = currentUserData.username;
            profileAirlineSpan.textContent = currentUserData.airline;
            if (currentUserData.profilePic) {
                profileImage.src = currentUserData.profilePic;
                currentProfilePic.src = currentUserData.profilePic;
            } else {
                profileImage.src = "https://placehold.co/100x100/A0AEC0/FFFFFF?text=P";
                currentProfilePic.src = "https://placehold.co/100x100/A0AEC0/FFFFFF?text=P";
            }
            loginPage.classList.add('hidden');
            mainApp.classList.remove('hidden');

            // Check if user is suspended
            if (currentUserData.status === 'suspended' && currentUserData.suspensionEndDate && new Date() < new Date(currentUserData.suspensionEndDate)) {
                showMessage(`Your account is suspended until ${new Date(currentUserData.suspensionEndDate).toLocaleString()}. Reason: ${currentUserData.suspensionNote || 'No reason provided.'}`, true);
                signOut(auth);
                return;
            } else if (currentUserData.status === 'suspended' && new Date() >= new Date(currentUserData.suspensionEndDate)) {
                // Suspension has expired, lift the suspension
                await updateDoc(userDocRef, {
                    status: 'active',
                    suspensionEndDate: null,
                    suspensionNote: null
                });
                showMessage("Your suspension has been lifted!");
            }
            
            // Check for admin privileges
            if (currentUserData.username === 'adminaccount') {
                adminTab.classList.remove('hidden');
            } else {
                adminTab.classList.add('hidden');
            }
        } else {
            // New user, show the profile setup modal
            profileSetupModal.classList.remove('hidden');
        }
    }

    // --- Event Listeners for Authentication ---
    loginBtn.addEventListener('click', async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        try {
            // Check for ban before attempting to log in
            const q = query(collection(db, `artifacts/${appId}/public/data/banned_users`), where("email", "==", email));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const banData = querySnapshot.docs[0].data();
                showMessage(`You have been permanently banned. Reason: ${banData.note}`, true);
                return;
            }

            await signInWithEmailAndPassword(auth, email, password);
            showMessage("Logged in successfully!");
        } catch (error) {
            console.error("Login failed:", error);
            showMessage("Login failed: " + error.message, true);
        }
    });

    signupBtn.addEventListener('click', async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showMessage("Account created! Redirecting to profile setup...");
            // onAuthStateChanged listener will handle showing the profile setup modal
        } catch (error) {
            console.error("Signup failed:", error);
            showMessage("Signup failed: " + error.message, true);
        }
    });

    googleBtn.addEventListener('click', async () => {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
            showMessage("Signed in with Google!");
            // onAuthStateChanged listener will handle the rest
        } catch (error) {
            console.error("Google sign-in failed:", error);
            showMessage("Google sign-in failed: " + error.message, true);
        }
    });
    
    // Log Out button listener
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showMessage("Logged out successfully!");
            // onAuthStateChanged listener will handle UI changes
        } catch (error) {
            console.error("Error logging out:", error);
            showMessage("Failed to log out.", true);
        }
    });


    // --- Profile Setup Modal Logic ---
    saveProfileBtn.addEventListener('click', async () => {
        const username = usernameInput.value.trim();
        const airline = airlineNameInput.value.trim();
        if (!username || !airline) {
            showMessage("Username and Airline cannot be empty.", true);
            return;
        }

        try {
            // Check if username is unique
            const q = query(collection(db, `artifacts/${appId}/users`), where("profile.data.username", "==", username));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                usernameStatus.textContent = "Username is already taken.";
                usernameStatus.classList.remove('text-green-500');
                usernameStatus.classList.add('text-red-500');
                return;
            }
            usernameStatus.textContent = "Username is available!";
            usernameStatus.classList.remove('text-red-500');
            usernameStatus.classList.add('text-green-500');

            // Save the user profile data
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            await setDoc(userDocRef, {
                username: username,
                airline: airline,
                profilePic: null, // Initial profile pic is null
                posts: [],
                following: [],
                followers: [],
                status: 'active', // New status field
            });
            showMessage("Profile saved successfully!");
            profileSetupModal.classList.add('hidden');
            await fetchUserData(); // Refresh data and show main app
        } catch (e) {
            console.error("Error setting up profile:", e);
            showMessage("Failed to save profile.", true);
        }
    });

    // --- Search Logic ---
    searchBar.addEventListener('input', async () => {
        const queryText = searchBar.value.trim().toLowerCase();
        if (queryText === '') {
            showSection('feed');
            return;
        }
        showSection('searchResults');
        
        // Clear previous results
        searchResultsContainer.innerHTML = '';
        
        try {
            // Simple search for posts containing the query in content or username
            const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
            const q = query(postsRef);
            const querySnapshot = await getDocs(q);
            
            let resultsFound = false;
            querySnapshot.forEach((doc) => {
                const post = doc.data();
                const postContent = post.content.toLowerCase();
                const username = post.authorUsername.toLowerCase();
                
                if (postContent.includes(queryText) || username.includes(queryText)) {
                    createPostElement(doc.id, post, searchResultsContainer);
                    resultsFound = true;
                }
            });

            if (!resultsFound) {
                searchResultsContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">No results found for "${searchBar.value}".</p>`;
            }
        } catch (e) {
            console.error("Error searching posts:", e);
            showMessage("Failed to perform search.", true);
        }
    });

    // --- Navigation Logic ---
    navButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const sectionName = e.currentTarget.id.replace('Tab', '');
            showSection(sectionName);
        });
    });

    function showSection(sectionName) {
        sections.forEach(section => {
            if (section.id === sectionName + 'Section') {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        });
        navButtons.forEach(button => {
            if (button.id === sectionName + 'Tab') {
                button.classList.add('active', 'text-blue-600');
                button.classList.remove('text-gray-400');
            } else {
                button.classList.remove('active', 'text-blue-600');
                button.classList.add('text-gray-400');
            }
        });
        
        // Refresh admin lists when the admin panel is opened
        if (sectionName === 'adminPanel') {
            fetchBannedAndSuspendedUsers();
        }
    }

    // --- Real-time Listeners ---
    function setupRealtimeListeners() {
        // Posts listener
        const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
        const postsQuery = query(postsRef);
        onSnapshot(postsQuery, (snapshot) => {
            feedContainer.innerHTML = '';
            const sortedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                           .sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            
            let hasPosts = false;
            sortedPosts.forEach(post => {
                // Get author data from the cached map
                const authorData = usersDataMap.get(post.authorId);
                // Only display the post if the author is not banned or suspended
                if (authorData && authorData.status !== 'banned' && authorData.status !== 'suspended') {
                    createPostElement(post.id, post, feedContainer);
                    hasPosts = true;
                }
            });

            if (!hasPosts) {
                 feedContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">No posts yet. Be the first to post!</p>`;
            }
        }, (error) => {
            console.error("Error fetching posts:", error);
            showMessage("Failed to load feed.", true);
        });

        // Messages listener
        const messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
        const messagesQuery = query(messagesRef);
        onSnapshot(messagesQuery, async (snapshot) => {
            messagesList.innerHTML = '';
            let hasMessages = false;
            // Filter messages for the current user (sent or received)
            const sortedMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                                .sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            for (const msg of sortedMessages) {
                if (msg.recipientId === userId || msg.senderId === userId) {
                    let otherUsername = "User";
                    if (msg.senderId !== userId) {
                        const senderData = usersDataMap.get(msg.senderId);
                        if (senderData) {
                            otherUsername = senderData.username;
                        }
                        const messageElement = document.createElement('div');
                        messageElement.className = 'bg-gray-200 p-4 rounded-xl shadow-sm';
                        messageElement.innerHTML = `
                            <p class="font-semibold text-gray-800">From: @${otherUsername}</p>
                            <p class="text-gray-600 mt-2">${msg.content}</p>
                            <p class="text-right text-xs text-gray-500 mt-2">${msg.createdAt.toDate().toLocaleString()}</p>
                        `;
                        messagesList.appendChild(messageElement);
                        hasMessages = true;
                    } else {
                        const recipientData = usersDataMap.get(msg.recipientId);
                        if (recipientData) {
                            otherUsername = recipientData.username;
                        }
                        const messageElement = document.createElement('div');
                        messageElement.className = 'bg-blue-100 p-4 rounded-xl shadow-sm';
                        messageElement.innerHTML = `
                            <p class="font-semibold text-gray-800">To: @${otherUsername}</p>
                            <p class="text-gray-600 mt-2">${msg.content}</p>
                            <p class="text-right text-xs text-gray-500 mt-2">${msg.createdAt.toDate().toLocaleString()}</p>
                        `;
                        messagesList.appendChild(messageElement);
                        hasMessages = true;
                    }
                }
            }

            if (!hasMessages) {
                messagesList.innerHTML = `<p class="text-center text-gray-500 mt-8">No messages yet.</p>`;
            }
        }, (error) => {
            console.error("Error fetching messages:", error);
            showMessage("Failed to load messages.", true);
        });
    }

    // --- Post Management ---
    function createPostElement(postId, postData, container) {
        const postElement = document.createElement('div');
        postElement.className = 'bg-white p-6 rounded-3xl shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer';
        postElement.setAttribute('data-post-id', postId);
        
        let authorData = usersDataMap.get(postData.authorId);
        if (!authorData) {
            authorData = { username: "Unknown User", airline: "" };
        }
        
        const contentStyle = `color:${postData.textColor || '#1c2a39'}; background-color:${postData.backgroundColor || '#ffffff'}; padding: 1rem; border-radius: 1.5rem;`;
        
        postElement.innerHTML = `
            <div class="flex items-center space-x-4 mb-4">
                <img src="${authorData.profilePic || 'https://placehold.co/50x50/A0AEC0/FFFFFF?text=P'}" class="w-12 h-12 rounded-full border-2 border-white shadow-sm">
                <div>
                    <span class="font-bold text-gray-800">@${authorData.username}</span>
                    <p class="text-sm text-gray-500">${authorData.airline}</p>
                </div>
            </div>
            <div class="post-content mb-4" style="${contentStyle}">
                <p class="text-base">${postData.content}</p>
            </div>
            ${postData.imageUrl ? `<img src="${postData.imageUrl}" class="rounded-xl w-full h-auto mb-4 border-2 border-gray-300">` : ''}
            <div class="flex items-center text-gray-500 text-sm">
                <span>${postData.likes.length} Likes</span>
                <span class="ml-4">${postData.replies ? postData.replies.length : 0} Replies</span>
            </div>
            <p class="text-xs text-gray-400 mt-2">Posted: ${new Date(postData.createdAt.toDate()).toLocaleString()}</p>
            <p class="text-xs text-gray-400 mt-1 break-all">Post ID: ${postId}</p>
        `;
        
        postElement.addEventListener('click', () => {
            viewPostDetail(postId, postData);
        });
        
        container.appendChild(postElement);
    }

    async function viewPostDetail(postId, postData) {
        postDetailContent.innerHTML = ''; // Clear previous content

        // Re-use the createPostElement function for the post content
        createPostElement(postId, postData, postDetailContent);
        
        // Display replies
        const repliesContainer = document.createElement('div');
        repliesContainer.className = 'mt-4 border-t border-gray-300 pt-4 space-y-4';
        
        if (postData.replies && postData.replies.length > 0) {
            postData.replies.forEach(reply => {
                const replyAuthor = usersDataMap.get(reply.authorId) || { username: "Unknown User" };
                const replyElement = document.createElement('div');
                replyElement.className = 'bg-gray-100 p-4 rounded-xl';
                replyElement.innerHTML = `
                    <p class="font-semibold text-gray-800">@${replyAuthor.username}</p>
                    <p class="text-gray-600 mt-1">${reply.content}</p>
                    <p class="text-xs text-gray-400 mt-2">${new Date(reply.createdAt.toDate()).toLocaleString()}</p>
                `;
                repliesContainer.appendChild(replyElement);
            });
        } else {
            repliesContainer.innerHTML = '<p class="text-center text-gray-500">No replies yet.</p>';
        }
        
        postDetailContent.appendChild(repliesContainer);
        
        submitReplyBtn.setAttribute('data-post-id', postId);
        postDetailModal.classList.remove('hidden');
    }

    closePostDetailBtn.addEventListener('click', () => {
        postDetailModal.classList.add('hidden');
    });

    submitReplyBtn.addEventListener('click', async () => {
        const postId = submitReplyBtn.getAttribute('data-post-id');
        const replyContent = replyText.value.trim();

        if (!replyContent) {
            showMessage("Reply content cannot be empty.", true);
            return;
        }

        try {
            const postDocRef = doc(db, `artifacts/${appId}/public/data/posts/${postId}`);
            await updateDoc(postDocRef, {
                replies: arrayUnion({
                    authorId: userId,
                    content: replyContent,
                    createdAt: new Date(),
                })
            });
            showMessage("Reply submitted!");
            replyText.value = '';
        } catch (e) {
            console.error("Error submitting reply:", e);
            showMessage("Failed to submit reply.", true);
        }
    });

    // --- Modal Handlers ---
    newPostBtn.addEventListener('click', () => newPostModal.classList.remove('hidden'));
    cancelPostBtn.addEventListener('click', () => newPostModal.classList.add('hidden'));
    newMessageBtn.addEventListener('click', () => newMessageModal.classList.remove('hidden'));
    cancelMessageBtn.addEventListener('click', () => newMessageModal.classList.add('hidden'));

    postImageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                postImagePreview.src = e.target.result;
                postImagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            postImagePreview.src = '';
            postImagePreviewContainer.classList.add('hidden');
        }
    });

    submitPostBtn.addEventListener('click', async () => {
        const content = postTextarea.value.trim();
        const imageUrl = postImagePreview.src;
        const textColor = postTextColor.value;
        const backgroundColor = postBackgroundColor.value;

        if (!content && !imageUrl) {
            showMessage("Post content or image cannot be empty.", true);
            return;
        }

        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), {
                authorId: userId,
                authorUsername: currentUserData.username,
                content: content,
                imageUrl: imageUrl === 'https://placehold.co/100x100/A0AEC0/FFFFFF?text=P' ? null : imageUrl,
                textColor: textColor,
                backgroundColor: backgroundColor,
                likes: [],
                replies: [],
                createdAt: new Date()
            });
            showMessage("Post submitted successfully!");
            newPostModal.classList.add('hidden');
            postTextarea.value = '';
            postImageInput.value = '';
            postImagePreview.src = '';
            postImagePreviewContainer.classList.add('hidden');
        } catch (e) {
            console.error("Error adding document:", e);
            showMessage("Failed to submit post.", true);
        }
    });

    sendMessageBtn.addEventListener('click', async () => {
        const recipientId = messageRecipientInput.value.trim();
        const content = messageTextarea.value.trim();

        if (!recipientId || !content) {
            showMessage("Recipient ID and message content cannot be empty.", true);
            return;
        }

        const recipientDocRef = doc(db, `artifacts/${appId}/users/${recipientId}/profile/data`);
        const recipientDocSnap = await getDoc(recipientDocRef);
        if (!recipientDocSnap.exists()) {
            showMessage("Recipient user ID does not exist.", true);
            return;
        }
        
        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/messages`), {
                senderId: userId,
                recipientId: recipientId,
                senderUsername: currentUserData.username,
                content: content,
                createdAt: new Date()
            });
            showMessage("Message sent successfully!");
            newMessageModal.classList.add('hidden');
            messageRecipientInput.value = '';
            messageTextarea.value = '';
        } catch (e) {
            console.error("Error sending message: ", e);
            showMessage("Failed to send message.", true);
        }
    });
    
    // --- Settings Logic ---
    saveSettingsBtn.addEventListener('click', async () => {
        const newUsername = settingsUsernameInput.value.trim();
        const newAirline = settingsAirlineInput.value.trim();

        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            const updateData = {};
            let isUsernameChanged = false;

            if (newUsername && newUsername !== currentUserData.username) {
                // Check if new username is unique
                const q = query(collection(db, `artifacts/${appId}/users`), where("profile.data.username", "==", newUsername));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    settingsUsernameStatus.textContent = "Username is already taken.";
                    settingsUsernameStatus.classList.remove('text-green-500');
                    settingsUsernameStatus.classList.add('text-red-500');
                    return;
                }
                updateData.username = newUsername;
                isUsernameChanged = true;
            }

            if (newAirline && newAirline !== currentUserData.airline) {
                updateData.airline = newAirline;
            }

            if (profilePictureInput.files[0]) {
                // Not implementing image upload to Firestore Storage for brevity, using placeholder
                // In a real app, this is where you'd upload the image and get a URL
                updateData.profilePic = "https://placehold.co/100x100/A0AEC0/FFFFFF?text=Updated";
            }

            if (Object.keys(updateData).length > 0) {
                await updateDoc(userDocRef, updateData);
                showMessage("Settings saved successfully!");
                if (isUsernameChanged) {
                    // Update username on all existing posts by this user
                    const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
                    const userPostsQuery = query(postsRef, where("authorId", "==", userId));
                    const userPostsSnapshot = await getDocs(userPostsQuery);
                    const batch = writeBatch(db);
                    userPostsSnapshot.forEach(postDoc => {
                        const postRef = doc(db, `artifacts/${appId}/public/data/posts/${postDoc.id}`);
                        batch.update(postRef, { authorUsername: newUsername });
                    });
                    await batch.commit();
                }
            } else {
                showMessage("No changes to save.", false);
            }
            await fetchUserData(); // Refresh data and UI
        } catch (e) {
            console.error("Error saving settings:", e);
            showMessage("Failed to save settings.", true);
        }
    });

    // --- Admin Panel Logic ---
    adminUsernameSearchInput.addEventListener('input', () => {
        const username = adminUsernameSearchInput.value.trim();
        const foundId = usersByUsernameMap.get(username);
        if (foundId) {
            foundUserIdDisplay.textContent = `User ID: ${foundId}`;
            adminUserIdInput.value = foundId;
            foundUserIdDisplay.classList.remove('text-red-500');
            foundUserIdDisplay.classList.add('text-green-500');
        } else {
            foundUserIdDisplay.textContent = 'No user found with that username.';
            adminUserIdInput.value = '';
            foundUserIdDisplay.classList.remove('text-green-500');
            foundUserIdDisplay.classList.add('text-red-500');
        }
    });

    banUserBtn.addEventListener('click', async () => {
        const targetId = adminUserIdInput.value.trim();
        const banNote = adminBanNoteInput.value.trim();

        if (!targetId || !banNote) {
            showMessage("Please provide a User ID and a ban note.", true);
            return;
        }

        try {
            await runTransaction(db, async (transaction) => {
                const userDocRef = doc(db, `artifacts/${appId}/users/${targetId}/profile/data`);
                const userDoc = await transaction.get(userDocRef);

                if (!userDoc.exists()) {
                    throw "User not found.";
                }
                
                // Get user's email for permanent ban list
                const authUser = await auth.getUser(targetId);
                const userEmail = authUser.email;

                // Update user profile status
                transaction.update(userDocRef, {
                    status: 'banned',
                    banNote: banNote
                });

                // Add user to a public banned list (for future login checks)
                const bannedRef = doc(db, `artifacts/${appId}/public/data/banned_users`, targetId);
                transaction.set(bannedRef, {
                    userId: targetId,
                    username: userDoc.data().username,
                    email: userEmail,
                    note: banNote,
                    bannedAt: new Date()
                });
            });

            // Sign out the user immediately if they are currently logged in
            if (auth.currentUser && auth.currentUser.uid === targetId) {
                await signOut(auth);
            }
            showMessage(`User with ID ${targetId} has been permanently banned.`);
            adminUserIdInput.value = '';
            adminBanNoteInput.value = '';
            fetchBannedAndSuspendedUsers();
        } catch (e) {
            console.error("Error banning user:", e);
            showMessage("Failed to ban user: " + e, true);
        }
    });

    suspendUserBtn.addEventListener('click', async () => {
        const targetId = adminUserIdInput.value.trim();
        const banNote = adminBanNoteInput.value.trim();
        const duration = parseInt(suspendDurationInput.value);

        if (!targetId || !banNote || isNaN(duration) || duration <= 0) {
            showMessage("Please provide a User ID, a suspension note, and a valid duration (in days).", true);
            return;
        }

        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${targetId}/profile/data`);
            const suspensionEndDate = new Date();
            suspensionEndDate.setDate(suspensionEndDate.getDate() + duration);

            await updateDoc(userDocRef, {
                status: 'suspended',
                suspensionEndDate: suspensionEndDate.toISOString(),
                suspensionNote: banNote
            });
            showMessage(`User with ID ${targetId} has been suspended for ${duration} days.`);
            adminUserIdInput.value = '';
            adminBanNoteInput.value = '';
            fetchBannedAndSuspendedUsers();
        } catch (e) {
            console.error("Error suspending user:", e);
            showMessage("Failed to suspend user: " + e, true);
        }
    });

    takeDownPostBtn.addEventListener('click', async () => {
        const postId = adminPostIdInput.value.trim();
        if (!postId) {
            showMessage("Please provide a Post ID to take down.", true);
            return;
        }

        try {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/posts`, postId));
            showMessage(`Post with ID ${postId} has been taken down.`);
            adminPostIdInput.value = '';
        } catch (e) {
            console.error("Error taking down post:", e);
            showMessage("Failed to take down post: " + e, true);
        }
    });
    
    // Fetch and display banned and suspended users for admin panel
    async function fetchBannedAndSuspendedUsers() {
        bannedSuspendedList.innerHTML = '';
        try {
            const usersRef = collection(db, `artifacts/${appId}/users`);
            const q = query(usersRef, where("profile.data.status", "in", ["banned", "suspended"]));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                bannedSuspendedList.innerHTML = `<p class="text-center text-gray-500">No users currently banned or suspended.</p>`;
                return;
            }
            
            querySnapshot.forEach(userDoc => {
                const userData = userDoc.data().profile.data;
                const userId = userDoc.id;
                const userElement = document.createElement('div');
                userElement.className = 'bg-gray-100 p-4 rounded-xl flex items-center justify-between';
                
                let statusText = userData.status;
                let actionBtnText = "Unban";
                let actionBtnClass = "bg-green-600 hover:bg-green-700";

                if (userData.status === 'suspended') {
                    const suspensionEndDate = new Date(userData.suspensionEndDate);
                    const remainingDays = Math.ceil((suspensionEndDate - new Date()) / (1000 * 60 * 60 * 24));
                    statusText = `Suspended (${remainingDays} days remaining)`;
                    actionBtnText = "Lift Suspension";
                    actionBtnClass = "bg-green-600 hover:bg-green-700";
                }
                
                userElement.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">@${userData.username}</p>
                        <p class="text-sm text-gray-600">ID: ${userId}</p>
                        <p class="text-xs text-red-500">${statusText}</p>
                        <p class="text-xs text-gray-500">Note: ${userData.banNote || userData.suspensionNote || 'N/A'}</p>
                    </div>
                    <button class="lift-ban-btn ${actionBtnClass} text-white font-bold py-2 px-4 rounded-lg transition duration-300" data-user-id="${userId}" data-status="${userData.status}">
                        ${actionBtnText}
                    </button>
                `;
                bannedSuspendedList.appendChild(userElement);
            });
            
            // Add click listeners to the dynamically created buttons
            bannedSuspendedList.querySelectorAll('.lift-ban-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const targetId = e.target.dataset.userId;
                    const status = e.target.dataset.status;

                    try {
                        const userDocRef = doc(db, `artifacts/${appId}/users/${targetId}/profile/data`);
                        const updateData = { status: 'active' };

                        if (status === 'suspended') {
                            updateData.suspensionEndDate = null;
                            updateData.suspensionNote = null;
                        } else if (status === 'banned') {
                            updateData.banNote = null;
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/banned_users`, targetId));
                        }

                        await updateDoc(userDocRef, updateData);
                        showMessage(`Action lifted for user ${targetId}.`);
                        fetchBannedAndSuspendedUsers(); // Refresh the list
                    } catch (e) {
                        console.error("Error lifting action:", e);
                        showMessage("Failed to lift action: " + e, true);
                    }
                });
            });

        } catch (e) {
            console.error("Error fetching banned/suspended users:", e);
            bannedSuspendedList.innerHTML = `<p class="text-center text-red-500">Failed to load list.</p>`;
        }
    }


    // Initial setup
    window.onload = initializeAndAuthenticate;
</script>
</body>
</html>
