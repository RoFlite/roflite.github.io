<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoFlite Social Media</title>
    <!-- Tailwind CSS CDN for modern styling and responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* General body and font styling for a light theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light background */
            color: #1c2a39; /* Dark text */
            height: 100vh;
        }
        /* Custom "liquid glass" effect class */
        .liquid-glass {
            background-color: rgba(255, 255, 255, 0.6); /* Semi-transparent white */
            backdrop-filter: blur(20px); /* The key to the liquid glass effect */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        /* Hover effect for liquid glass elements */
        .liquid-glass:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        /* Smooth animation for page transitions */
        .fade-in {
            animation: fadeIn 0.8s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar styling for a clean look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(200, 200, 200, 0.5);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
            border: 2px solid rgba(200, 200, 200, 0);
        }
        /* Style for a custom, no-alert message box */
        #messageBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            text-align: center;
        }
        #messageBox.show {
            opacity: 1;
            pointer-events: auto;
        }
        /* Hide a section to start with */
        .section.hidden {
            display: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-8">

<!-- Custom Message Box for non-alert notifications -->
<div id="messageBox" class="bg-blue-600 text-white shadow-lg"></div>

<!-- Login/Signup Page -->
<div id="loginPage" class="liquid-glass w-full max-w-md p-8 sm:p-12 text-center fade-in overflow-y-auto max-h-[95vh]">
    <h1 class="text-4xl font-bold text-gray-800 mb-6">RoFlite</h1>
    <p class="text-sm text-gray-600 mb-8">Log in or create an account to get started!</p>
    <div class="mb-4">
        <input type="email" id="emailInput" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
    </div>
    <div class="mb-6">
        <input type="password" id="passwordInput" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
    </div>
    <button id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105">
        Login
    </button>
    <button id="signupBtn" class="w-full mt-4 bg-gray-600 text-white font-bold py-3 rounded-xl hover:bg-gray-700 transition duration-300 transform hover:scale-105">
        Sign Up
    </button>
    
    <div class="my-8">
        <div class="relative flex py-5 items-center">
            <div class="flex-grow border-t border-gray-300"></div>
            <span class="flex-shrink mx-4 text-gray-500">Or sign in with</span>
            <div class="flex-grow border-t border-gray-300"></div>
        </div>
        <div class="flex justify-center">
            <button id="googleBtn" class="flex items-center justify-center p-3 border rounded-xl hover:bg-gray-200 transition-colors duration-300 shadow-sm">
                <!-- Google Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-google-icon mr-2"><path d="M22 12h-4c0-2.03-1.65-3.67-4.14-3.96C12.39 7.7 11 8.24 11 9.5a2.5 2.5 0 0 1-5 0c0-1.26-1.39-1.8-2.86-1.54C2.65 8.33 1 10.02 1 12c0 1.98 1.65 3.67 4.14 3.96 1.47.26 2.86-.28 2.86-1.54a2.5 2.5 0 0 1 5 0c0 1.26 1.39 1.8 2.86 1.54C18.35 15.67 20 13.98 20 12h2"/><path d="M12 22a10 10 0 0 1-4.88-1.07c-3.15-.9-5.12-3.8-5.12-7.43a10 10 0 0 1 10-10 10 10 0 0 1 10 10z"/></svg>
                Google
            </button>
        </div>
    </div>
</div>

<!-- Profile Setup Modal -->
<div id="profileSetupModal" class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="liquid-glass w-full max-w-md p-8 relative fade-in text-center">
        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Complete Your Profile</h3>
        <p class="text-gray-600 mb-4">You're almost there! Just a few more details to get started.</p>
        <div class="mb-4">
            <input type="text" id="airlineName" placeholder="Airline Name (e.g., Ro-Aviation)" class="w-full p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
        </div>
        <div class="mb-6">
            <input type="text" id="username" placeholder="Username" class="w-full p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <p id="usernameStatus" class="text-left text-xs mt-1 h-4"></p>
        </div>
        <button id="saveProfileBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105">
            Save Profile
        </button>
    </div>
</div>

<!-- Main Application Page -->
<div id="mainApp" class="hidden w-full max-w-4xl h-[90vh] md:h-[80vh] flex flex-col liquid-glass p-6 sm:p-8 fade-in">
    <!-- Header with Search Bar and User ID -->
    <header class="flex items-center justify-between pb-4 border-b border-gray-300 mb-4">
        <h1 class="text-3xl font-bold text-gray-800">RoFlite</h1>
        <div class="flex-1 max-w-xs mx-4">
            <div class="relative">
                <input type="text" id="searchBar" placeholder="Search posts..." class="w-full p-2 pl-10 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">üîç</span>
            </div>
        </div>
        <div class="text-xs text-right text-gray-500 break-words max-w-[200px]">
            Your Account ID:<br><span id="currentUserId" class="font-mono text-gray-700 text-[10px] sm:text-xs"></span>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto pr-2 pb-2">
        <!-- Feed Section -->
        <div id="feedSection" class="section active">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Feed</h2>
            <div id="postsContainer" class="space-y-4">
                <!-- Posts will be dynamically inserted here -->
            </div>
        </div>

        <!-- Search Results Section -->
        <div id="searchResultsSection" class="section hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Search Results</h2>
            <div id="searchResultsContainer" class="space-y-4">
                <!-- Search results will be dynamically inserted here -->
            </div>
        </div>

        <!-- Messages Section -->
        <div id="messagesSection" class="section hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Messages</h2>
            <div id="messagesList" class="space-y-4">
                <!-- Messages will be dynamically inserted here -->
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="section hidden">
            <div class="flex items-center space-x-4 mb-6">
                <img id="profileImage" src="https://placehold.co/100x100/A0AEC0/FFFFFF?text=P" class="w-24 h-24 rounded-full border-4 border-white shadow-md">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-800">Profile</h2>
                    <p class="text-gray-600">@<span id="profileUsername" class="font-bold text-blue-600"></span></p>
                    <p class="text-gray-600"><span id="profileAirline" class="font-bold text-blue-600"></span></p>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="section hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Settings</h2>
            <div class="space-y-6">
                <div>
                    <label for="settingsUsernameInput" class="block text-sm font-medium text-gray-700">Change Username</label>
                    <input type="text" id="settingsUsernameInput" placeholder="New Username" class="mt-1 w-full p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                    <p id="settingsUsernameStatus" class="text-xs mt-1 h-4"></p>
                </div>
                <div>
                    <label for="settingsAirlineInput" class="block text-sm font-medium text-gray-700">Change Airline</label>
                    <input type="text" id="settingsAirlineInput" placeholder="New Airline" class="mt-1 w-full p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                </div>
                <div class="flex items-center space-x-4">
                    <img id="currentProfilePic" src="https://placehold.co/100x100/A0AEC0/FFFFFF?text=P" class="w-20 h-20 rounded-full border-2 border-gray-300">
                    <label class="block">
                        <span class="sr-only">Choose profile photo</span>
                        <input type="file" id="profilePictureInput" accept="image/*" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100
                        "/>
                    </label>
                </div>
                <button id="saveSettingsBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="flex justify-center space-x-4 mt-6">
        <button id="newPostBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-110">
            ‚ûï Post
        </button>
        <button id="newMessageBtn" class="bg-emerald-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-emerald-700 transition duration-300 transform hover:scale-110">
            üí¨ Message
        </button>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="mt-4 pt-4 border-t border-gray-300">
        <ul class="flex justify-around items-center">
            <li><button id="feedTab" class="nav-btn active text-blue-600 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">üìÑ<span class="block text-xs">Feed</span></button></li>
            <li><button id="messagesTab" class="nav-btn text-gray-400 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">‚úâÔ∏è<span class="block text-xs">Messages</span></button></li>
            <li><button id="profileTab" class="nav-btn text-gray-400 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">üë§<span class="block text-xs">Profile</span></button></li>
            <li><button id="settingsTab" class="nav-btn text-gray-400 font-medium py-2 px-4 rounded-xl transition-colors duration-300 hover:bg-gray-200">‚öôÔ∏è<span class="block text-xs">Settings</span></button></li>
        </ul>
    </nav>
</div>

<!-- New Post Modal -->
<div id="newPostModal" class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="liquid-glass w-full max-w-md p-8 relative fade-in">
        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Create New Post</h3>
        <textarea id="postText" class="w-full h-32 p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 resize-none mb-4" placeholder="What's on your mind?"></textarea>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Add an image</label>
            <input type="file" id="postImageInput" accept="image/*" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100
            "/>
            <div id="postImagePreviewContainer" class="mt-4 hidden">
                <img id="postImagePreview" class="w-full h-auto rounded-lg border-2 border-gray-300 shadow-sm">
            </div>
        </div>
        <div class="flex justify-between items-center mb-4">
            <div>
                <label for="postTextColor" class="text-gray-700">Text Color:</label>
                <input type="color" id="postTextColor" value="#1c2a39" class="h-8 w-8 rounded-full border border-gray-300 cursor-pointer">
            </div>
            <div>
                <label for="postBackgroundColor" class="text-gray-700">Background Color:</label>
                <input type="color" id="postBackgroundColor" value="#ffffff" class="h-8 w-8 rounded-full border border-gray-300 cursor-pointer">
            </div>
        </div>
        <div class="flex justify-end space-x-4">
            <button id="cancelPostBtn" class="bg-gray-400 text-gray-800 py-2 px-6 rounded-xl hover:bg-gray-500 transition duration-300">Cancel</button>
            <button id="submitPostBtn" class="bg-blue-600 text-white py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300">Post</button>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div id="newMessageModal" class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="liquid-glass w-full max-w-md p-8 relative fade-in">
        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Send Private Message</h3>
        <input type="text" id="messageRecipient" placeholder="Recipient's User ID (e.g., a8c-123-abc)" class="w-full p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-300 mb-4">
        <textarea id="messageText" class="w-full h-32 p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-300 resize-none mb-4" placeholder="Your message..."></textarea>
        <div class="flex justify-end space-x-4">
            <button id="cancelMessageBtn" class="bg-gray-400 text-gray-800 py-2 px-6 rounded-xl hover:bg-gray-500 transition duration-300">Cancel</button>
            <button id="sendMessageBtn" class="bg-emerald-600 text-white py-2 px-6 rounded-xl hover:bg-emerald-700 transition duration-300">Send</button>
        </div>
    </div>
</div>

<!-- Post Detail Modal -->
<div id="postDetailModal" class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div class="liquid-glass w-full max-w-2xl h-[90vh] flex flex-col p-8 relative fade-in">
        <button id="closePostDetailBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
        </button>
        <!-- Post content will be inserted here -->
        <div id="postDetailContent" class="flex-1 overflow-y-auto pr-2 pb-2 mb-4"></div>
        <!-- Reply form -->
        <div class="mt-auto pt-4 border-t border-gray-300">
            <h4 class="text-xl font-semibold mb-4 text-gray-800">Leave a Reply</h4>
            <textarea id="replyText" class="w-full h-24 p-3 rounded-lg bg-gray-200 border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 resize-none mb-4" placeholder="Your reply..."></textarea>
            <button id="submitReplyBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                Reply
            </button>
        </div>
    </div>
</div>

<!-- JavaScript for functionality -->
<script type="module">
    // Firebase CDN imports. These are essential for connecting to the database.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        signInAnonymously,
        signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, where, getDocs, onSnapshot, arrayUnion, arrayRemove, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase configuration. These are hardcoded as requested.
    // Replace these values with your actual Firebase project configuration.
    const firebaseConfig = {
        apiKey: "AIzaSyDxEVWH3ukcs2C0tTa08faIGOarGsReZxo",
        authDomain: "project-7604626948994220056.firebaseapp.com",
        projectId: "project-7604626948994220056",
        storageBucket: "project-7604626948994220056.firebasestorage.app",
        messagingSenderId: "288162968865",
        appId: "1:288162968865:web:8e35c777371c1e4fe4ba60",
        measurementId: "G-N3KC2BJPR8"
    };

    const appId = "default-app-id";
    const initialAuthToken = ""; // Placeholder for the custom auth token

    // --- DOM Elements ---
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const messageBox = document.getElementById('messageBox');
    const currentUserIdSpan = document.getElementById('currentUserId');
    const searchBar = document.getElementById('searchBar');

    const googleBtn = document.getElementById('googleBtn');

    const navButtons = document.querySelectorAll('.nav-btn');
    const sections = document.querySelectorAll('.section');
    const feedContainer = document.getElementById('postsContainer');
    const searchResultsContainer = document.getElementById('searchResultsContainer');
    const messagesList = document.getElementById('messagesList');
    const profileUsernameSpan = document.getElementById('profileUsername');
    const profileAirlineSpan = document.getElementById('profileAirline');
    const profileImage = document.getElementById('profileImage');
    
    const settingsUsernameInput = document.getElementById('settingsUsernameInput');
    const settingsAirlineInput = document.getElementById('settingsAirlineInput');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const profilePictureInput = document.getElementById('profilePictureInput');
    const currentProfilePic = document.getElementById('currentProfilePic');
    const settingsUsernameStatus = document.getElementById('settingsUsernameStatus');

    const newPostBtn = document.getElementById('newPostBtn');
    const newMessageBtn = document.getElementById('newMessageBtn');
    const newPostModal = document.getElementById('newPostModal');
    const newMessageModal = document.getElementById('newMessageModal');
    const postDetailModal = document.getElementById('postDetailModal');
    const postDetailContent = document.getElementById('postDetailContent');
    const closePostDetailBtn = document.getElementById('closePostDetailBtn');
    const replyText = document.getElementById('replyText');
    const submitReplyBtn = document.getElementById('submitReplyBtn');

    const cancelPostBtn = document.getElementById('cancelPostBtn');
    const submitPostBtn = document.getElementById('submitPostBtn');
    const cancelMessageBtn = document.getElementById('cancelMessageBtn');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const postTextarea = document.getElementById('postText');
    const messageRecipientInput = document.getElementById('messageRecipient');
    const messageTextarea = document.getElementById('messageText');
    const postTextColor = document.getElementById('postTextColor');
    const postBackgroundColor = document.getElementById('postBackgroundColor');
    
    const postImageInput = document.getElementById('postImageInput');
    const postImagePreview = document.getElementById('postImagePreview');
    const postImagePreviewContainer = document.getElementById('postImagePreviewContainer');

    const profileSetupModal = document.getElementById('profileSetupModal');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const airlineNameInput = document.getElementById('airlineName');
    const usernameInput = document.getElementById('username');
    const usernameStatus = document.getElementById('usernameStatus');

    // --- Firebase Setup ---
    let db, auth, userId;
    let currentUserData = null;

    // Show a temporary message to the user
    function showMessage(text, isError = false) {
        messageBox.textContent = text;
        messageBox.className = 'show ' + (isError ? 'bg-red-600' : 'bg-blue-600');
        setTimeout(() => {
            messageBox.className = '';
        }, 3000);
    }

    // Initialize Firebase and handle authentication
    async function initializeAndAuthenticate() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sign in with the custom token or anonymously
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    currentUserIdSpan.textContent = userId;
                    await fetchUserData();
                    // Setup listeners only once we are sure the user is authenticated
                    setupRealtimeListeners();
                } else {
                    // Show login page if no user is signed in
                    loginPage.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                }
            });
        } catch (error) {
            console.error("Error initializing Firebase or signing in:", error);
            showMessage("Failed to initialize. Please try again.", true);
        }
    }

    // --- Main Functions ---
    // Fetch and display current user data
    async function fetchUserData() {
        if (!userId) return;
        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists()) {
            currentUserData = userDocSnap.data();
            profileUsernameSpan.textContent = currentUserData.username;
            profileAirlineSpan.textContent = currentUserData.airline;
            if (currentUserData.profilePic) {
                profileImage.src = currentUserData.profilePic;
                currentProfilePic.src = currentUserData.profilePic;
            } else {
                profileImage.src = "https://placehold.co/100x100/A0AEC0/FFFFFF?text=P";
                currentProfilePic.src = "https://placehold.co/100x100/A0AEC0/FFFFFF?text=P";
            }
            settingsUsernameInput.value = currentUserData.username;
            settingsAirlineInput.value = currentUserData.airline;
            loginPage.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('fade-in');
        } else {
            // New user, show profile setup modal
            profileSetupModal.classList.remove('hidden');
            loginPage.classList.add('hidden');
        }
    }

    // Handle user signup
    async function handleSignup() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
            showMessage("Please enter both email and password.", true);
            return;
        }

        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showMessage("Account created successfully! Please complete your profile.");
        } catch (e) {
            console.error("Error signing up:", e);
            showMessage("Error creating account: " + e.message, true);
        }
    }

    // Handle user login
    async function handleLogin() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
            showMessage("Please enter both email and password.", true);
            return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
            showMessage("Logged in successfully! Welcome back.");
        } catch (e) {
            console.error("Error logging in:", e);
            showMessage("Login failed: " + e.message, true);
        }
    }

    // Handle social sign-in
    async function handleSocialSignIn(provider) {
        try {
            await signInWithPopup(auth, provider);
            showMessage("Signed in successfully!");
        } catch (error) {
            console.error("Social sign-in failed:", error);
            showMessage("Social sign-in failed: " + error.message, true);
        }
    }

    // Handle saving the user's profile data
    async function handleSaveProfile() {
        saveProfileBtn.disabled = true;
        saveProfileBtn.textContent = 'Saving...';

        const airlineName = airlineNameInput.value.trim();
        const username = usernameInput.value.trim();

        if (!airlineName || !username) {
            showMessage("Please enter both an airline name and a username.", true);
            saveProfileBtn.disabled = false;
            saveProfileBtn.textContent = 'Save Profile';
            return;
        }

        try {
            // Use runTransaction to ensure the username check and save are atomic
            await runTransaction(db, async (transaction) => {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                const usernameCheckRef = doc(db, `artifacts/${appId}/public/data/usernames/${username.toLowerCase()}`);

                // Check for username uniqueness again inside the transaction for safety
                const usernameDocSnap = await transaction.get(usernameCheckRef);
                if (usernameDocSnap.exists()) {
                     // This should ideally not happen if the first check passed, but is good practice
                    throw new Error("Username already taken.");
                }

                // Save profile data
                transaction.set(userDocRef, {
                    username: username,
                    airline: airlineName,
                    createdAt: new Date()
                });

                // Create a separate document to track the username
                transaction.set(usernameCheckRef, {
                    userId: userId
                });
            });

            showMessage("Profile saved successfully!");
            profileSetupModal.classList.add('hidden');
            fetchUserData(); // Transition to the main app
        } catch (e) {
            console.error("Error setting user profile: ", e);
            // Check for the specific error thrown in the transaction
            if (e.message === "Username already taken.") {
                 showMessage("That username is already taken. Please choose another.", true);
                 usernameStatus.textContent = "Username unavailable";
                 usernameStatus.style.color = "red";
            } else {
                showMessage("An error occurred while saving profile.", true);
            }
        } finally {
            saveProfileBtn.disabled = false;
            saveProfileBtn.textContent = 'Save Profile';
        }
    }

    async function handleSaveSettings() {
        saveSettingsBtn.disabled = true;
        saveSettingsBtn.textContent = 'Saving...';

        const newUsername = settingsUsernameInput.value.trim();
        const newAirline = settingsAirlineInput.value.trim();
        let newProfilePic = currentUserData.profilePic || null;

        if (profilePictureInput.files && profilePictureInput.files[0]) {
            const file = profilePictureInput.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                newProfilePic = reader.result;
                await updateProfile(newUsername, newAirline, newProfilePic);
                saveSettingsBtn.disabled = false;
                saveSettingsBtn.textContent = 'Save Changes';
            };
            reader.onerror = () => {
                showMessage("Failed to read image file.", true);
                saveSettingsBtn.disabled = false;
                saveSettingsBtn.textContent = 'Save Changes';
            };
        } else {
            await updateProfile(newUsername, newAirline, newProfilePic);
            saveSettingsBtn.disabled = false;
            saveSettingsBtn.textContent = 'Save Changes';
        }
    }

    async function updateProfile(newUsername, newAirline, newProfilePic) {
        try {
            await runTransaction(db, async (transaction) => {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                const oldUsername = currentUserData.username;

                // Check for username uniqueness if it changed
                if (newUsername !== oldUsername) {
                    const usernameCheckRef = doc(db, `artifacts/${appId}/public/data/usernames/${newUsername.toLowerCase()}`);
                    const usernameDocSnap = await transaction.get(usernameCheckRef);
                    if (usernameDocSnap.exists()) {
                        throw new Error("Username already taken.");
                    }
                    // Delete old username document and create new one
                    if (oldUsername) {
                         const oldUsernameRef = doc(db, `artifacts/${appId}/public/data/usernames/${oldUsername.toLowerCase()}`);
                         transaction.delete(oldUsernameRef);
                    }
                    transaction.set(usernameCheckRef, { userId: userId });
                }

                // Update user profile document
                transaction.update(userDocRef, {
                    username: newUsername,
                    airline: newAirline,
                    profilePic: newProfilePic
                });
            });

            showMessage("Settings saved successfully!");
            fetchUserData(); // Refresh UI with new data
        } catch (e) {
            console.error("Error updating settings: ", e);
            if (e.message === "Username already taken.") {
                 showMessage("That username is already taken. Please choose another.", true);
                 settingsUsernameStatus.textContent = "Username unavailable";
                 settingsUsernameStatus.style.color = "red";
            } else {
                showMessage("An error occurred while saving settings.", true);
            }
        }
    }

    // Handle liking/unliking a post
    async function likePost(postId) {
        if (!userId) {
            showMessage("Please log in to like posts.", true);
            return;
        }

        const postDocRef = doc(db, `artifacts/${appId}/public/data/posts/${postId}`);
        try {
            await runTransaction(db, async (transaction) => {
                const postDoc = await transaction.get(postDocRef);
                if (!postDoc.exists()) {
                    throw "Post does not exist!";
                }

                const currentLikes = postDoc.data().likes || [];
                const isLiked = currentLikes.includes(userId);

                if (isLiked) {
                    transaction.update(postDocRef, {
                        likes: arrayRemove(userId)
                    });
                } else {
                    transaction.update(postDocRef, {
                        likes: arrayUnion(userId)
                    });
                }
            });
        } catch (e) {
            console.error("Transaction failed: ", e);
            showMessage("Failed to like/unlike post. Please try again.", true);
        }
    }

    // Handle posting a reply
    async function submitReply(postId) {
        const replyContent = replyText.value.trim();
        if (!replyContent) {
            showMessage("Reply content cannot be empty.", true);
            return;
        }

        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/posts/${postId}/replies`), {
                content: replyContent,
                authorId: userId,
                username: currentUserData.username,
                profilePic: currentUserData.profilePic,
                createdAt: new Date()
            });
            showMessage("Reply posted successfully!");
            replyText.value = '';
        } catch (e) {
            console.error("Error adding reply: ", e);
            showMessage("Failed to post reply.", true);
        }
    }

    // --- Real-time Listeners ---
    function setupRealtimeListeners() {
        // Listen for new posts in the public feed
        const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
        const unsubscribePosts = onSnapshot(postsRef, (snapshot) => {
            const posts = [];
            snapshot.forEach(doc => {
                posts.push({ id: doc.id, ...doc.data() });
            });
            posts.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            renderPosts(posts);
            // Re-render search results to keep them up to date
            searchPosts(searchBar.value);
        });

        // Listen for messages private to the current user
        const messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
        const messagesQuery = query(messagesRef, where('recipientId', '==', userId));
        const unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
            const messages = [];
            snapshot.forEach(doc => {
                const messageData = doc.data();
                messages.push({
                    id: doc.id,
                    ...messageData
                });
            });
            messages.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            renderMessages(messages);
        });
    }

    // --- Rendering Functions ---
    function renderPosts(posts) {
        feedContainer.innerHTML = '';
        if (posts.length === 0) {
            feedContainer.innerHTML = '<div class="text-center text-gray-500 py-8">No posts yet. Be the first to post!</div>';
            return;
        }
        posts.forEach(post => {
            const isLiked = post.likes && post.likes.includes(userId);
            const likeCount = post.likes ? post.likes.length : 0;
            const likeButtonColor = isLiked ? 'text-blue-600' : 'text-gray-400';
            const postBgColor = post.backgroundColor || 'rgba(255, 255, 255, 0.6)';
            const postTextColor = post.textColor || '#1c2a39';
            const profilePicSrc = post.profilePic || "https://placehold.co/48x48/A0AEC0/FFFFFF?text=P";
            const postImageHtml = post.postImage ? `<img src="${post.postImage}" class="mt-4 rounded-lg shadow-md w-full h-auto object-cover max-h-[400px]">` : '';


            const postElement = document.createElement('div');
            postElement.className = 'liquid-glass p-4 rounded-xl cursor-pointer';
            postElement.style.backgroundColor = postBgColor;
            postElement.style.color = postTextColor;
            postElement.innerHTML = `
                <div class="flex items-start space-x-4 mb-2">
                    <img src="${profilePicSrc}" class="w-12 h-12 rounded-full border-2 border-white shadow-md">
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-lg">${post.username}</span>
                            <span class="text-xs text-gray-500">${post.airline}</span>
                        </div>
                        <p class="text-sm mt-1 whitespace-pre-wrap" style="color:${postTextColor};">${post.content}</p>
                    </div>
                </div>
                ${postImageHtml}
                <div class="flex justify-between items-center text-xs text-gray-500 mt-2">
                    <button class="like-btn flex items-center space-x-1" data-post-id="${post.id}">
                        <span class="w-4 h-4 transition-colors duration-200 ${likeButtonColor}">‚ù§Ô∏è</span>
                        <span>${likeCount}</span>
                    </button>
                    <span class="text-right">Posted: ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'N/A'}</span>
                </div>
            `;
            feedContainer.appendChild(postElement);
            // Add click listener for the like button
            postElement.querySelector('.like-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                likePost(post.id);
            });
            // Add click listener to open post detail modal
            postElement.addEventListener('click', () => {
                showPostDetail(post.id);
            });
        });
    }

    async function showPostDetail(postId) {
        try {
            const postDocRef = doc(db, `artifacts/${appId}/public/data/posts/${postId}`);
            const postDocSnap = await getDoc(postDocRef);
            if (!postDocSnap.exists()) {
                showMessage("Post not found.", true);
                return;
            }
            const post = { id: postDocSnap.id, ...postDocSnap.data() };
            
            const postBgColor = post.backgroundColor || 'rgba(255, 255, 255, 0.6)';
            const postTextColor = post.textColor || '#1c2a39';
            const profilePicSrc = post.profilePic || "https://placehold.co/48x48/A0AEC0/FFFFFF?text=P";
            const postImageHtml = post.postImage ? `<img src="${post.postImage}" class="mt-4 rounded-lg shadow-md w-full h-auto object-contain max-h-[400px]">` : '';

            postDetailContent.innerHTML = `
                <div class="liquid-glass p-4 rounded-xl mb-4" style="background-color:${postBgColor}; color:${postTextColor};">
                    <div class="flex items-start space-x-4 mb-2">
                        <img src="${profilePicSrc}" class="w-12 h-12 rounded-full border-2 border-white shadow-md">
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="font-bold text-lg">${post.username}</span>
                                <span class="text-xs text-gray-500">${post.airline}</span>
                            </div>
                            <p class="text-sm mt-1 whitespace-pre-wrap" style="color:${postTextColor};">${post.content}</p>
                        </div>
                    </div>
                    ${postImageHtml}
                    <div class="flex justify-between items-center text-xs text-gray-500 mt-2">
                        <span>Likes: ${post.likes ? post.likes.length : 0}</span>
                        <span>Posted: ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'N/A'}</span>
                    </div>
                </div>
                <h4 class="text-xl font-semibold mb-4 text-gray-800">Replies</h4>
                <div id="repliesContainer" class="space-y-4"></div>
            `;

            // Set up reply listener
            const repliesContainer = document.getElementById('repliesContainer');
            const repliesRef = collection(db, `artifacts/${appId}/public/data/posts/${postId}/replies`);
            const unsubscribeReplies = onSnapshot(repliesRef, (snapshot) => {
                const replies = [];
                snapshot.forEach(doc => {
                    replies.push({ id: doc.id, ...doc.data() });
                });
                replies.sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate()); // Sort chronologically
                repliesContainer.innerHTML = '';
                if (replies.length === 0) {
                    repliesContainer.innerHTML = '<div class="text-center text-gray-500 py-4">No replies yet.</div>';
                }
                replies.forEach(reply => {
                    const replyProfilePic = reply.profilePic || "https://placehold.co/48x48/A0AEC0/FFFFFF?text=P";
                    const replyElement = document.createElement('div');
                    replyElement.className = 'liquid-glass p-4 rounded-xl';
                    replyElement.innerHTML = `
                        <div class="flex items-start space-x-4">
                            <img src="${replyProfilePic}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-md">${reply.username}</span>
                                    <span class="text-xs text-gray-500">${reply.createdAt ? new Date(reply.createdAt.toDate()).toLocaleString() : 'N/A'}</span>
                                </div>
                                <p class="text-sm mt-1 whitespace-pre-wrap">${reply.content}</p>
                            </div>
                        </div>
                    `;
                    repliesContainer.appendChild(replyElement);
                });
            });

            // Make sure to remove old listener when modal is closed
            closePostDetailBtn.onclick = () => {
                unsubscribeReplies();
                postDetailModal.classList.add('hidden');
            };

            submitReplyBtn.onclick = () => submitReply(postId);

            postDetailModal.classList.remove('hidden');

        } catch (e) {
            console.error("Error fetching post details:", e);
            showMessage("Failed to load post details.", true);
        }
    }


    function renderSearchResults(posts) {
        searchResultsContainer.innerHTML = '';
        if (posts.length === 0) {
            searchResultsContainer.innerHTML = '<div class="text-center text-gray-500 py-8">No posts match your search.</div>';
            return;
        }
        posts.forEach(post => {
            const isLiked = post.likes && post.likes.includes(userId);
            const likeCount = post.likes ? post.likes.length : 0;
            const likeButtonColor = isLiked ? 'text-blue-600' : 'text-gray-400';
            const postBgColor = post.backgroundColor || 'rgba(255, 255, 255, 0.6)';
            const postTextColor = post.textColor || '#1c2a39';
            const profilePicSrc = post.profilePic || "https://placehold.co/48x48/A0AEC0/FFFFFF?text=P";
            const postImageHtml = post.postImage ? `<img src="${post.postImage}" class="mt-4 rounded-lg shadow-md w-full h-auto object-cover max-h-[400px]">` : '';

            const postElement = document.createElement('div');
            postElement.className = 'liquid-glass p-4 rounded-xl cursor-pointer';
            postElement.style.backgroundColor = postBgColor;
            postElement.style.color = postTextColor;
            postElement.innerHTML = `
                <div class="flex items-start space-x-4 mb-2">
                    <img src="${profilePicSrc}" class="w-12 h-12 rounded-full border-2 border-white shadow-md">
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-lg">${post.username}</span>
                            <span class="text-xs text-gray-500">${post.airline}</span>
                        </div>
                        <p class="text-sm mt-1 whitespace-pre-wrap" style="color:${postTextColor};">${post.content}</p>
                    </div>
                </div>
                ${postImageHtml}
                <div class="flex justify-between items-center text-xs text-gray-500 mt-2">
                    <button class="like-btn flex items-center space-x-1" data-post-id="${post.id}">
                        <span class="w-4 h-4 transition-colors duration-200 ${likeButtonColor}">‚ù§Ô∏è</span>
                        <span>${likeCount}</span>
                    </button>
                    <span class="text-right">Posted: ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'N/A'}</span>
                </div>
            `;
            searchResultsContainer.appendChild(postElement);
            postElement.querySelector('.like-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                likePost(post.id);
            });
            postElement.addEventListener('click', () => {
                showPostDetail(post.id);
            });
        });
    }

    function renderMessages(messages) {
        messagesList.innerHTML = '';
        if (messages.length === 0) {
            messagesList.innerHTML = '<div class="text-center text-gray-500 py-8">No messages yet.</div>';
            return;
        }
        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.className = 'liquid-glass p-4 rounded-xl';
            const date = message.createdAt ? new Date(message.createdAt.toDate()).toLocaleString() : 'N/A';
            messageElement.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold text-emerald-600">From: ${message.senderUsername}</span>
                    <span class="text-xs text-gray-500">${date}</span>
                </div>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">${message.content}</p>
            `;
            messagesList.appendChild(messageElement);
        });
    }

    // --- Search Functionality ---
    let allPosts = [];
    let initialPostsListenerUnsubscribe = null;

    function searchPosts(queryText) {
        const lowerCaseQuery = queryText.toLowerCase();
        if (lowerCaseQuery.length > 0) {
            const filteredPosts = allPosts.filter(post =>
                post.content.toLowerCase().includes(lowerCaseQuery) ||
                post.username.toLowerCase().includes(lowerCaseQuery) ||
                post.airline.toLowerCase().includes(lowerCaseQuery)
            );
            renderSearchResults(filteredPosts);
            showSection('searchResultsSection');
        } else {
            showSection('feedSection');
        }
    }

    function showSection(sectionId) {
        sections.forEach(sec => sec.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
        navButtons.forEach(btn => btn.classList.remove('active', 'text-blue-600'));
        navButtons.forEach(btn => btn.classList.add('text-gray-400'));
        document.getElementById(`${sectionId.replace('Section', 'Tab')}`).classList.add('active', 'text-blue-600');
    }

    // --- Event Listeners ---
    loginBtn.addEventListener('click', handleLogin);
    signupBtn.addEventListener('click', handleSignup);
    saveProfileBtn.addEventListener('click', handleSaveProfile);
    saveSettingsBtn.addEventListener('click', handleSaveSettings);
    usernameInput.addEventListener('input', () => {
        usernameStatus.textContent = ''; // Clear status on input
    });
    settingsUsernameInput.addEventListener('input', () => {
        settingsUsernameStatus.textContent = '';
    });
    searchBar.addEventListener('input', (e) => searchPosts(e.target.value));

    // Social Login Button
    googleBtn.addEventListener('click', () => handleSocialSignIn(new GoogleAuthProvider()));

    // Navigation
    navButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const targetId = e.currentTarget.id.replace('Tab', 'Section');
            showSection(targetId);
        });
    });

    // Modals
    newPostBtn.addEventListener('click', () => {
        newPostModal.classList.remove('hidden');
    });

    cancelPostBtn.addEventListener('click', () => {
        newPostModal.classList.add('hidden');
        postTextarea.value = '';
        postImageInput.value = '';
        postImagePreviewContainer.classList.add('hidden');
        postImagePreview.src = '';
    });
    
    postImageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                postImagePreview.src = e.target.result;
                postImagePreviewContainer.classList.remove('hidden');
            };
            reader.onerror = () => {
                showMessage("Failed to read image file.", true);
                postImageInput.value = '';
                postImagePreviewContainer.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            postImagePreviewContainer.classList.add('hidden');
        }
    });

    submitPostBtn.addEventListener('click', async () => {
        const content = postTextarea.value.trim();
        const postImage = postImagePreview.src;
        if (!content && !postImage) {
            showMessage("Post content or an image is required.", true);
            return;
        }

        try {
            const newPostData = {
                username: currentUserData.username,
                airline: currentUserData.airline,
                profilePic: currentUserData.profilePic || null,
                content: content,
                textColor: postTextColor.value,
                backgroundColor: postBackgroundColor.value,
                createdAt: new Date(),
                authorId: userId,
                likes: []
            };

            if (postImage) {
                newPostData.postImage = postImage;
            }

            await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), newPostData);
            
            showMessage("Post created successfully!");
            newPostModal.classList.add('hidden');
            postTextarea.value = '';
            postImageInput.value = '';
            postImagePreviewContainer.classList.add('hidden');
            postImagePreview.src = '';
        } catch (e) {
            console.error("Error adding document: ", e);
            showMessage("Failed to create post.", true);
        }
    });

    newMessageBtn.addEventListener('click', () => {
        newMessageModal.classList.remove('hidden');
    });

    cancelMessageBtn.addEventListener('click', () => {
        newMessageModal.classList.add('hidden');
        messageRecipientInput.value = '';
        messageTextarea.value = '';
    });

    sendMessageBtn.addEventListener('click', async () => {
        const recipientId = messageRecipientInput.value.trim();
        const content = messageTextarea.value.trim();

        if (!recipientId || !content) {
            showMessage("Recipient ID and message content cannot be empty.", true);
            return;
        }

        const recipientDocRef = doc(db, `artifacts/${appId}/users/${recipientId}/profile/data`);
        const recipientDocSnap = await getDoc(recipientDocRef);
        if (!recipientDocSnap.exists()) {
            showMessage("Recipient user ID does not exist.", true);
            return;
        }
        
        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/messages`), {
                senderId: userId,
                recipientId: recipientId,
                senderUsername: currentUserData.username,
                content: content,
                createdAt: new Date()
            });
            showMessage("Message sent successfully!");
            newMessageModal.classList.add('hidden');
            messageRecipientInput.value = '';
            messageTextarea.value = '';
        } catch (e) {
            console.error("Error sending message: ", e);
            showMessage("Failed to send message.", true);
        }
    });

    // Initial setup
    window.onload = initializeAndAuthenticate;
</script>
</body>
</html>
